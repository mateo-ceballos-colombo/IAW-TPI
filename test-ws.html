<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Test WebSocket Occupancy</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 16px;
        }

        #statusText {
            font-weight: bold;
        }

        #log {
            background: #111;
            color: #0f0;
            padding: 8px;
            height: 220px;
            overflow-y: auto;
            font-size: 12px;
        }

        input {
            padding: 4px;
        }

        button {
            padding: 4px 8px;
            margin-left: 4px;
        }
    </style>
</head>

<body>
    <h1>Test WebSocket Occupancy</h1>

    <div>
        WebSocket: <span id="wsConn">Desconectado</span>
    </div>

    <div style="margin-top: 10px;">
        Room ID:
        <input id="roomInput" size="30" value="TU_ROOM_ID_AQUI" />
        <button id="btnSubscribe">Suscribirse a room</button>
    </div>

    <div style="margin-top: 10px;">
        Estado de la sala: <span id="statusText">desconocido</span>
    </div>

    <h3>Log</h3>
    <pre id="log"></pre>

    <script>
        const token = "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJUU1E5ajQtQm92MjI2VWxhQWlYNlRvQXNQd1RVTUJGamxTUUJ4Z2IycGNVIn0.eyJleHAiOjE3NjQyMDI5NTEsImlhdCI6MTc2NDIwMjY1MSwianRpIjoiNjY2OTUxNDAtN2EzYS00ZWQwLWEwYjEtYTgzN2JkMTc3ZDQ5IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9jb3dvcmtyZXNlcnZlIiwiYXVkIjoiYWNjb3VudCIsInN1YiI6IjU2NDRlMWQ5LTQ0YTItNDhlNi1hYmUwLTg1ZmM4YmQ0YzYyZSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImNvd29yay1hcGkiLCJzZXNzaW9uX3N0YXRlIjoiYTYyNzk1OWQtNzQ2Mi00YzhjLTk5ZTQtZThiZDU3ZGU1MGM5IiwiYWNyIjoiMSIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImFkbWluIiwidW1hX2F1dGhvcml6YXRpb24iLCJkZWZhdWx0LXJvbGVzLWNvd29ya3Jlc2VydmUiXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6ImVtYWlsIHByb2ZpbGUiLCJzaWQiOiJhNjI3OTU5ZC03NDYyLTRjOGMtOTllNC1lOGJkNTdkZTUwYzkiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6InRwaS1hZG1pbiJ9.OTw_-ynIVsdH4B11dygPmz_3Yt7pvYO0XLfp0mNaNgZHCMa_KeolhuI-KexyYFtsdCSu1S6idaWJgR45yLgTcg0dEOSmSTA2EMKSJ9_HjtjWUc2oi5hvTfXusSFeUpqXEq5i2Udzlvq4a0KyDGLf07h3l1h7Gmud4Ofqb3FSYMOal--OujZcNL1k6p--OJzgkr5ixh-Oces9-yXYXiMiu05jq0AqZP1qK8QZ_qapYcNncVZEnTLt1Pf9V4JDPm1X07-w1kVCiiF46hn996EE90tGVDQQvqDxURVgVJaeWv8Ae3RkHl5QZ_VsyD1bObZ1cgRq1DGOVezep3SqZBkR9Q";

        const wsConnEl = document.getElementById("wsConn");
        const roomInput = document.getElementById("roomInput");
        const btnSubscribe = document.getElementById("btnSubscribe");
        const statusText = document.getElementById("statusText");
        const logEl = document.getElementById("log");

        function log(msg) {
            const time = new Date().toISOString();
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(msg);
        }

        function renderStatus(occupied) {
            statusText.textContent = occupied ? "OCUPADA" : "LIBRE";
            statusText.style.color = occupied ? "red" : "green";
        }

        // Conexión al WebSocket
        const socket = io("http://localhost:5000", {
            auth: { token },
            transports: ["websocket"]
        });

        socket.on("connect", () => {
            wsConnEl.textContent = "Conectado (" + socket.id + ")";
            wsConnEl.style.color = "green";
            log("Conectado al WS con id " + socket.id);
        });

        socket.on("disconnect", (reason) => {
            wsConnEl.textContent = "Desconectado (" + reason + ")";
            wsConnEl.style.color = "red";
            log("Desconectado: " + reason);
        });

        socket.on("connect_error", (err) => {
            wsConnEl.textContent = "Error: " + err.message;
            wsConnEl.style.color = "red";
            log("Error de conexión: " + err.message);
        });

        // Suscribirse a una sala para recibir occupancyUpdate
        btnSubscribe.onclick = () => {
            const roomId = roomInput.value.trim();
            if (!roomId) {
                alert("Ingresá un roomId");
                return;
            }
            log("Suscribiéndose a room: " + roomId);
            socket.emit("subscribeRoom", roomId);
        };

        // Escuchar actualizaciones de ocupación
        socket.on("occupancyUpdate", (msg) => {
            log("occupancyUpdate recibido: " + JSON.stringify(msg));
            // Se espera: { roomId, occupied }
            if (typeof msg.occupied !== "undefined") {
                renderStatus(!!msg.occupied);
            }
        });
    </script>
</body>

</html>